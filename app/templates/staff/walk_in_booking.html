{% extends "base.html" %}

{% block content %}
<!--Flatpickr_CSS-->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

<div class="max-w-3xl mx-auto">
    <h1 class="text-3xl font-bold mb-6 text-gray-800">{{ title }}</h1>
    <div class="bg-white p-8 rounded-xl shadow-2xl transform hover:scale-[1.01] transition duration-300">
        <div class="bg-gradient-to-r from-indigo-50 to-blue-50 border-l-4 border-indigo-500 rounded-lg p-4 mb-6">
            <p class="text-gray-700 text-sm">
                <span class="font-semibold">üë§ Walk-in Booking:</span> Create a booking for walk-in customers. If the customer doesn't have an account, one will be created automatically with a default password.
            </p>
        </div>
        
        <form method="POST" action="">
            {{ form.hidden_tag() }}
            <div class="space-y-6">
                <!--Customer_Information-->
                <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-6 shadow-md">
                    <h3 class="text-xl font-bold mb-4 text-purple-700 flex items-center">
                        <span class="mr-2">üë§</span> Customer Information
                    </h3>
                    <div class="space-y-4">
                        <div>
                            {{ form.customer_name.label(class="block text-sm font-semibold text-gray-700 mb-2") }}
                            {{ form.customer_name(class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition duration-200 hover:border-purple-400", placeholder="Enter customer full name") }}
                            {% if form.customer_name.errors %}
                                <div class="text-red-600 text-sm mt-2 font-medium">
                                    {% for error in form.customer_name.errors %}
                                        <p>‚ö†Ô∏è {{ error }}</p>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <div>
                            {{ form.customer_email.label(class="block text-sm font-semibold text-gray-700 mb-2") }}
                            {{ form.customer_email(class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition duration-200 hover:border-purple-400", placeholder="customer@example.com") }}
                            {% if form.customer_email.errors %}
                                <div class="text-red-600 text-sm mt-2 font-medium">
                                    {% for error in form.customer_email.errors %}
                                        <p>‚ö†Ô∏è {{ error }}</p>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!--Booking_Information-->
                <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-6 shadow-md">
                    <h3 class="text-xl font-bold mb-4 text-blue-700 flex items-center">
                        <span class="mr-2">üè®</span> Booking Details
                    </h3>
                    <div class="space-y-4">
                        <div>
                            {{ form.room_id.label(class="block text-sm font-semibold text-gray-700 mb-2") }}
                            {{ form.room_id(class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 hover:border-blue-400") }}
                            {% if form.room_id.errors %}
                                <div class="text-red-600 text-sm mt-2 font-medium">
                                    {% for error in form.room_id.errors %}
                                        <p>‚ö†Ô∏è {{ error }}</p>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                {{ form.checkin_date.label(class="block text-sm font-semibold text-gray-700 mb-2") }}
                                {{ form.checkin_date(class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 hover:border-blue-400", id="checkin-date") }}
                                {% if form.checkin_date.errors %}
                                    <div class="text-red-600 text-sm mt-2 font-medium">
                                        {% for error in form.checkin_date.errors %}
                                            <p>‚ö†Ô∏è {{ error }}</p>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            <div>
                                {{ form.checkout_date.label(class="block text-sm font-semibold text-gray-700 mb-2") }}
                                {{ form.checkout_date(class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 hover:border-blue-400", id="checkout-date") }}
                                {% if form.checkout_date.errors %}
                                    <div class="text-red-600 text-sm mt-2 font-medium">
                                        {% for error in form.checkout_date.errors %}
                                            <p>‚ö†Ô∏è {{ error }}</p>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!--Note-->
                <div class="bg-gradient-to-r from-green-50 to-emerald-50 border-l-4 border-green-500 rounded-xl p-5 shadow-md">
                    <p class="text-sm text-gray-700">
                        <strong class="text-green-700">üí° Note:</strong> Walk-in bookings are marked as <span class="px-2 py-1 bg-green-500 text-white rounded-full text-xs font-semibold">Paid</span> by default. The system will automatically calculate the total price based on room rate and number of nights.
                    </p>
                </div>

                <!--Actions-->
                <div class="flex gap-4 pt-4">
                    {{ form.submit(class="flex-1 px-6 py-3 font-bold text-white bg-gradient-to-r from-indigo-600 to-blue-600 rounded-xl shadow-lg hover:shadow-xl transform hover:-translate-y-1 hover:scale-105 transition duration-300") }}
                    <a href="{{ url_for('staff.view_bookings') }}" class="flex-1 text-center px-6 py-3 font-semibold text-gray-700 bg-gray-200 rounded-xl border-2 border-gray-300 hover:bg-gray-300 hover:border-gray-400 shadow-md hover:shadow-lg transform hover:scale-105 transition duration-300">‚ùå Cancel</a>
                </div>
            </div>
        </form>
    </div>
</div>

<!--Flatpickr_JavaScript-->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        let checkinPicker, checkoutPicker;
        
        // Initialize flatpickr for check-in date
        checkinPicker = flatpickr("#checkin-date", {
            minDate: today,
            dateFormat: "Y-m-d",
            onChange: function(selectedDates, dateStr, instance) {
                // Update checkout minimum to same day as checkin (allow same-day checkout)
                if (selectedDates.length > 0) {
                    checkoutPicker.set('minDate', selectedDates[0]);
                }
            }
        });
        
        // Initialize flatpickr for check-out date
        checkoutPicker = flatpickr("#checkout-date", {
            minDate: today,
            dateFormat: "Y-m-d"
        });
        
        // When room is selected, fetch booked dates and update calendar
        const roomSelect = document.getElementById('room_id');
        if (roomSelect) {
            roomSelect.addEventListener('change', function() {
                const roomId = this.value;
                if (!roomId) return;
                
                // Fetch booked dates for the selected room
                fetch(`/staff/api/room/${roomId}/booked-dates`)
                    .then(response => response.json())
                    .then(data => {
                        const disabledDates = [];
                        data.forEach(booking => {
                            const startDate = new Date(booking.check_in + 'T00:00:00');
                            const endDate = new Date(booking.check_out + 'T00:00:00');
                            
                            // If same-day booking
                            if (booking.check_in === booking.check_out) {
                                disabledDates.push(booking.check_in);
                            } else {
                                // Disable all dates from check-in up to (not including) check-out
                                for (let d = new Date(startDate); d < endDate; d.setDate(d.getDate() + 1)) {
                                    const dateStr = d.toISOString().split('T')[0];
                                    disabledDates.push(dateStr);
                                }
                            }
                        });
                        
                        // Update both pickers with disabled dates
                        checkinPicker.set('disable', disabledDates);
                        checkoutPicker.set('disable', disabledDates);
                    })
                    .catch(error => {
                        console.error('Error fetching booked dates:', error);
                    });
            });
        }
    });
</script>
{% endblock %}
